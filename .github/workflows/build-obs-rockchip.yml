name: Build OBS with ffmpeg-rockchip

on:
  workflow_dispatch:
    inputs:
      obs_version:
        description: "OBS Studio tag/version (e.g. 32.0.0)"
        required: false
        default: "32.0.2"
        type: string
      obs_repo:
        description: "OBS Studio source repository URL"
        required: false
        default: "https://github.com/obsproject/obs-studio.git"
        type: string
      ffmpeg_branch:
        description: "ffmpeg-rockchip branch/tag (e.g. 7.1)"
        required: false
        default: "6.1"
        type: string
      cef_version:
        description: "CEF version (e.g. 6533_linux_aarch64_v6)"
        required: false
        default: "6533_linux_aarch64_v6"
        type: string
      ignore_cache:
        description: "Ignore/disable dependency cache for a clean build"
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    env:
      OBS_VERSION: ${{ inputs.obs_version }}
      OBS_REPO: ${{ inputs.obs_repo }}
      FFMPEG_BRANCH: ${{ inputs.ffmpeg_branch }}
      CEF_VERSION: ${{ inputs.cef_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache CEF (version-independent)
        uses: actions/cache@v4
        if: ${{ !inputs.ignore_cache }}
        with:
          path: |
            ${{ github.workspace }}/cef
            ${{ github.workspace }}/cef.tar.bz2
          key: cef-cache-${{ runner.os }}-${{ inputs.cef_version }}
          restore-keys: |
            cef-cache-${{ runner.os }}-

      - name: Cache ccache (version-independent)
        uses: actions/cache@v4
        if: ${{ !inputs.ignore_cache }}
        with:
          path: ${{ github.workspace }}/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('scripts/build-obs-rockchip.sh') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Cache FFmpeg dependencies (version-dependent)
        uses: actions/cache@v4
        if: ${{ !inputs.ignore_cache }}
        with:
          path: ${{ github.workspace }}/install/ffmpeg-rockchip
          key: ffmpeg-cache-${{ runner.os }}-${{ inputs.ffmpeg_branch }}-${{ hashFiles('scripts/build-obs-rockchip.sh') }}
          restore-keys: |
            ffmpeg-cache-${{ runner.os }}-${{ inputs.ffmpeg_branch }}-
            ffmpeg-cache-${{ runner.os }}-

      - name: Make script executable
        run: chmod +x scripts/build-obs-rockchip.sh

      - name: Build OBS with ffmpeg-rockchip
        env:
          WORKSPACE: ${{ github.workspace }}
          NUM_JOBS: 4
          CCACHE_DIR: ${{ github.workspace }}/.ccache
          USE_CCACHE: ${{ inputs.ignore_cache && '0' || '1' }}
          OBS_VERSION: ${{ inputs.obs_version }}
          OBS_REPO: ${{ inputs.obs_repo }}
          FFMPEG_BRANCH: ${{ inputs.ffmpeg_branch }}
          CEF_VERSION: ${{ inputs.cef_version }}
        run: scripts/build-obs-rockchip.sh

      - name: Save CEF cache
        uses: actions/cache/save@v4
        if: ${{ !inputs.ignore_cache }}
        with:
          path: |
            ${{ github.workspace }}/cef
            ${{ github.workspace }}/cef.tar.bz2
          key: cef-cache-${{ runner.os }}-${{ inputs.cef_version }}

      - name: Save ccache
        uses: actions/cache/save@v4
        if: ${{ !inputs.ignore_cache }}
        with:
          path: ${{ github.workspace }}/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('scripts/build-obs-rockchip.sh') }}

      - name: Save FFmpeg cache
        uses: actions/cache/save@v4
        if: ${{ !inputs.ignore_cache }}
        with:
          path: ${{ github.workspace }}/install/ffmpeg-rockchip
          key: ffmpeg-cache-${{ runner.os }}-${{ inputs.ffmpeg_branch }}-${{ hashFiles('scripts/build-obs-rockchip.sh') }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: obs-rockchip-debs-${{ env.OBS_VERSION }}
          path: artifacts/*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ env.OBS_VERSION }}-rockchip-browser"
          name: "OBS Studio ${{ env.OBS_VERSION }} for Rockchip"
          body: |
            ## OBS Studio ${{ env.OBS_VERSION }} for Rockchip ARM64
            
            A specialized build of OBS Studio optimized for Rockchip ARM64 platforms (RK3588/RK3588s) with:
            
            ### Features
            - **Hardware-accelerated encoding/decoding** using Rockchip MPP (Media Process Platform)
            - **2D graphics acceleration** using Rockchip RGA (Raster Graphic Acceleration) 
            - **Browser source support** using CEF ${{ env.CEF_VERSION }}
            - **Custom FFmpeg** with Rockchip extensions (branch: ${{ env.FFMPEG_BRANCH }})
            - **Qt6 interface** with Wayland support
            - **PipeWire audio** support
            
            ### Installation
            ```bash
            sudo dpkg -i obs-studio_*.deb
            sudo apt-get install -f  # Fix any dependency issues
            ```
            
            ### Compatibility
            - Tested on Ubuntu 24.04 ARM64
            - Requires Rockchip RK3588/RK3588s SoC
            - Requires Mesa drivers with DRM support
            
            Built on: Run #${{ github.run_number }} (GitHub Actions)
          files: artifacts/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
